// Kattenbak Webshop - Enterprise Database Schema
// PostgreSQL + Prisma ORM

generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["fullTextSearch", "fullTextIndex"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// ENUMS
// ============================================

enum UserRole {
  ADMIN
  CUSTOMER
}

enum OrderStatus {
  PENDING // Nieuw, nog niet betaald
  PAYMENT_PENDING // Wacht op betaling
  PAID // Betaald
  PROCESSING // In behandeling
  SHIPPED // Verzonden
  DELIVERED // Afgeleverd
  CANCELLED // Geannuleerd
  REFUNDED // Terugbetaald
}

enum PaymentStatus {
  PENDING
  PAID
  FAILED
  CANCELLED
  REFUNDED
  EXPIRED
}

enum PaymentMethod {
  IDEAL
  CREDITCARD
  BANCONTACT
  PAYPAL
  SOFORT
  BANK_TRANSFER
}

enum ShipmentStatus {
  PENDING
  LABEL_CREATED
  IN_TRANSIT
  DELIVERED
  RETURNED
  FAILED
}

// ============================================
// USER MANAGEMENT
// ============================================

model User {
  id           String   @id @default(cuid())
  email        String   @unique
  passwordHash String   @map("password_hash")
  role         UserRole @default(CUSTOMER)
  firstName    String?  @map("first_name")
  lastName     String?  @map("last_name")
  phone        String?

  // Timestamps
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")
  lastLoginAt DateTime? @map("last_login_at")

  // Relations
  addresses Address[]
  orders    Order[]
  auditLogs AuditLog[]

  @@map("users")
}

model Address {
  id     String  @id @default(cuid())
  userId String? @map("user_id")

  // Address fields
  firstName   String  @map("first_name")
  lastName    String  @map("last_name")
  street      String
  houseNumber String  @map("house_number")
  addition    String?
  postalCode  String  @map("postal_code")
  city        String
  country     String  @default("NL")
  phone       String?

  isDefault Boolean @default(false) @map("is_default")

  // Timestamps
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  user           User?   @relation(fields: [userId], references: [id], onDelete: Cascade)
  ordersShipping Order[] @relation("ShippingAddress")
  ordersBilling  Order[] @relation("BillingAddress")

  @@map("addresses")
}

// ============================================
// PRODUCT CATALOG
// ============================================

model Category {
  id          String  @id @default(cuid())
  name        String
  slug        String  @unique
  description String?
  image       String?
  parentId    String? @map("parent_id")
  sortOrder   Int     @default(0) @map("sort_order")
  isActive    Boolean @default(true) @map("is_active")

  // Timestamps
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Self-referencing (hierarchical categories)
  parent   Category?  @relation("CategoryHierarchy", fields: [parentId], references: [id])
  children Category[] @relation("CategoryHierarchy")

  // Relations
  products Product[]

  @@map("categories")
}

model Product {
  id               String  @id @default(cuid())
  sku              String  @unique
  name             String
  slug             String  @unique
  description      String?
  shortDescription String? @map("short_description")

  // Pricing
  price          Decimal  @db.Decimal(10, 2)
  compareAtPrice Decimal? @map("compare_at_price") @db.Decimal(10, 2)
  costPrice      Decimal? @map("cost_price") @db.Decimal(10, 2)

  // Inventory
  stock             Int     @default(0)
  lowStockThreshold Int     @default(10) @map("low_stock_threshold")
  trackInventory    Boolean @default(true) @map("track_inventory")

  // Product info
  weight     Decimal? @db.Decimal(10, 2) // in kg
  dimensions Json? // {length, width, height} in cm

  // Images (array of URLs) - DEFAULT images if no variants
  images Json @default("[]")
  
  // Video URL (YouTube, Vimeo, etc.)
  videoUrl String? @map("video_url")
  
  // USP Images (for zigzag section)
  uspImage1 String? @map("usp_image1")
  uspImage2 String? @map("usp_image2")
  
  // Variant settings
  hasVariants Boolean @default(false) @map("has_variants") // Enable color variants

  // SEO
  metaTitle       String? @map("meta_title")
  metaDescription String? @map("meta_description")

  // Status
  isActive   Boolean @default(true) @map("is_active")
  isFeatured Boolean @default(false) @map("is_featured")

  // Pre-order support
  isPreOrder       Boolean   @default(false) @map("is_pre_order")
  preOrderDiscount Decimal?  @map("pre_order_discount") @db.Decimal(5, 2) // Percentage discount (e.g., 20.00 for 20%)
  releaseDate      DateTime? @map("release_date")

  // Timestamps
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")
  publishedAt DateTime? @map("published_at")

  // Relations
  categoryId String?           @map("category_id")
  category   Category?         @relation(fields: [categoryId], references: [id])
  orderItems OrderItem[]
  variants   ProductVariant[] // Color variants

  @@map("products")
}

// ============================================
// PRODUCT VARIANTS (Colors/Options)
// ============================================

model ProductVariant {
  id        String @id @default(cuid())
  productId String @map("product_id")

  // Variant details
  name           String // e.g., "Zwart", "Wit"
  sku            String  @unique // Unique SKU per variant
  colorCode      String? @map("color_code") // Hex code e.g., "#000000"
  colorImageUrl  String? @map("color_image_url") // Visual sample of the color
  
  // Pricing (optional override)
  priceAdjustment Decimal? @map("price_adjustment") @db.Decimal(10, 2) // +/- price difference
  
  // Inventory per variant
  stock Int @default(0)

  // Images for THIS variant (JSON array of URLs)
  images Json @default("[]") // Product photos in this color
  
  // Status
  isActive Boolean @default(true) @map("is_active")
  sortOrder Int @default(0) @map("sort_order") // Display order

  // Timestamps
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  product    Product     @relation(fields: [productId], references: [id], onDelete: Cascade)
  orderItems OrderItem[]

  @@map("product_variants")
}

// ============================================
// ORDER MANAGEMENT
// ============================================

model Order {
  id          String  @id @default(cuid())
  orderNumber String  @unique @map("order_number")
  userId      String? @map("user_id")

  // Customer info (denormalized for guests)
  customerEmail String  @map("customer_email")
  customerPhone String? @map("customer_phone")

  // Addresses
  shippingAddressId String? @map("shipping_address_id")
  billingAddressId  String? @map("billing_address_id")

  // Amounts
  subtotal     Decimal @db.Decimal(10, 2)
  shippingCost Decimal @default(0) @map("shipping_cost") @db.Decimal(10, 2)
  tax          Decimal @default(0) @db.Decimal(10, 2)
  discount     Decimal @default(0) @db.Decimal(10, 2)
  total        Decimal @db.Decimal(10, 2)

  // Status
  status OrderStatus @default(PENDING)

  // Notes
  customerNotes String? @map("customer_notes")
  adminNotes    String? @map("admin_notes")

  // Timestamps
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")
  completedAt DateTime? @map("completed_at")

  // Relations
  user            User?       @relation(fields: [userId], references: [id])
  shippingAddress Address?    @relation("ShippingAddress", fields: [shippingAddressId], references: [id])
  billingAddress  Address?    @relation("BillingAddress", fields: [billingAddressId], references: [id])
  items           OrderItem[]
  payment         Payment?
  shipment        Shipment?
  returns         Return[]

  @@map("orders")
}

model OrderItem {
  id        String  @id @default(cuid())
  orderId   String  @map("order_id")
  productId String  @map("product_id")
  variantId String? @map("variant_id") // Optional: if product has variants

  // Snapshot data (prices at time of order)
  productName  String  @map("product_name")
  productSku   String  @map("product_sku")
  variantName  String? @map("variant_name") // e.g., "Zwart"
  variantColor String? @map("variant_color") // e.g., "#000000"
  price        Decimal @db.Decimal(10, 2)
  quantity     Int
  subtotal     Decimal @db.Decimal(10, 2)

  // Timestamps
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  order   Order           @relation(fields: [orderId], references: [id], onDelete: Cascade)
  product Product         @relation(fields: [productId], references: [id])
  variant ProductVariant? @relation(fields: [variantId], references: [id])

  @@map("order_items")
}

// ============================================
// PAYMENT MANAGEMENT (Mollie)
// ============================================

model Payment {
  id      String @id @default(cuid())
  orderId String @unique @map("order_id")

  // Mollie integration
  mollieId String? @unique @map("mollie_id")

  // Payment details
  amount   Decimal        @db.Decimal(10, 2)
  currency String         @default("EUR")
  method   PaymentMethod?
  status   PaymentStatus  @default(PENDING)

  // URLs
  checkoutUrl String? @map("checkout_url")
  webhookUrl  String? @map("webhook_url")
  redirectUrl String? @map("redirect_url")

  // Additional data
  description String?
  metadata    Json?

  // Error tracking
  failureReason String? @map("failure_reason")

  // Timestamps
  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @updatedAt @map("updated_at")
  paidAt    DateTime? @map("paid_at")
  expiresAt DateTime? @map("expires_at")

  // Relations
  order Order @relation(fields: [orderId], references: [id], onDelete: Cascade)

  @@map("payments")
}

// ============================================
// SHIPPING MANAGEMENT (MyParcel)
// ============================================

model Shipment {
  id      String @id @default(cuid())
  orderId String @unique @map("order_id")

  // MyParcel integration
  myparcelId Int? @unique @map("myparcel_id")

  // Tracking
  trackingCode String? @unique @map("tracking_code")
  trackingUrl  String? @map("tracking_url")

  // Shipment details
  carrier     String  @default("PostNL")
  serviceType String? @map("service_type") // standard, morning, evening
  packageType String  @default("package") @map("package_type")

  // Status
  status ShipmentStatus @default(PENDING)

  // Additional options
  signature Boolean @default(false)
  insurance Int? // Amount in cents

  // Label
  labelUrl String? @map("label_url")

  // Metadata
  metadata Json?

  // Timestamps
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")
  shippedAt   DateTime? @map("shipped_at")
  deliveredAt DateTime? @map("delivered_at")

  // Relations
  order Order @relation(fields: [orderId], references: [id], onDelete: Cascade)

  @@map("shipments")
}

// ============================================
// RETURN MANAGEMENT (MyParcel Returns)
// ============================================

enum ReturnStatus {
  REQUESTED        // Klant heeft retour aangevraagd
  LABEL_CREATED    // Return label is aangemaakt bij MyParcel
  LABEL_SENT       // Email met label is verzonden
  IN_TRANSIT       // Retour is onderweg
  RECEIVED         // Retour is ontvangen in warehouse
  INSPECTED        // Retour is ge√Ønspecteerd
  APPROVED         // Retour is goedgekeurd
  REJECTED         // Retour is afgekeurd
  REFUND_PENDING   // Terugbetaling in behandeling
  REFUND_PROCESSED // Terugbetaald
  CLOSED           // Afgerond
}

enum ReturnReason {
  DEFECTIVE         // Product is defect
  WRONG_ITEM        // Verkeerd artikel
  NOT_AS_DESCRIBED  // Niet zoals beschreven
  CHANGED_MIND      // Van gedachten veranderd
  DAMAGED_SHIPPING  // Beschadigd tijdens verzending
  OTHER             // Anders
}

model Return {
  id       String @id @default(cuid())
  orderId  String @map("order_id")
  
  // MyParcel integration
  myparcelId   Int?    @unique @map("myparcel_id")
  trackingCode String? @map("tracking_code")
  trackingUrl  String? @map("tracking_url")
  labelUrl     String? @map("label_url")
  
  // Return details
  reason        ReturnReason @default(OTHER)
  reasonDetails String?      @map("reason_details")
  status        ReturnStatus @default(REQUESTED)
  
  // Items being returned (JSON array)
  items Json @default("[]") // {productId, productName, quantity, price}[]
  
  // Financial
  refundAmount Decimal? @map("refund_amount") @db.Decimal(10, 2)
  
  // Notes
  customerNotes String? @map("customer_notes")
  adminNotes    String? @map("admin_notes")
  
  // Customer photos (evidence)
  customerPhotos Json? @map("customer_photos") @default("[]") // Array of URLs
  
  // Email tracking
  emailSentAt DateTime? @map("email_sent_at")
  
  // Timestamps
  createdAt  DateTime  @default(now()) @map("created_at")
  updatedAt  DateTime  @updatedAt @map("updated_at")
  receivedAt DateTime? @map("received_at")
  refundedAt DateTime? @map("refunded_at")
  closedAt   DateTime? @map("closed_at")
  
  // Relations
  order Order @relation(fields: [orderId], references: [id], onDelete: Cascade)
  
  @@map("returns")
}

// ============================================
// AUDIT & LOGGING
// ============================================

model AuditLog {
  id     String  @id @default(cuid())
  userId String? @map("user_id")

  // Action details
  action   String // CREATE, UPDATE, DELETE, LOGIN, etc.
  entity   String // Product, Order, User, etc.
  entityId String? @map("entity_id")

  // Data
  oldValues Json? @map("old_values")
  newValues Json? @map("new_values")

  // Request info
  ipAddress String? @map("ip_address")
  userAgent String? @map("user_agent")

  // Timestamp
  createdAt DateTime @default(now()) @map("created_at")

  // Relations
  user User? @relation(fields: [userId], references: [id])

  @@map("audit_logs")
}

// ============================================
// SYSTEM CONFIGURATION
// ============================================

model Setting {
  id          String  @id @default(cuid())
  key         String  @unique
  value       Json
  description String?

  // Timestamps
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("settings")
}
