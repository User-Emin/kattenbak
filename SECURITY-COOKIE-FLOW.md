# üîí SECURITY & COOKIE FLOW - GDPR COMPLIANT

## ‚úÖ MAXIMAAL DRY, SECURE & MAINTAINABLE

### üéØ COOKIE CONSENT FLOW

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  User bezoekt site                                      ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                ‚îÇ
                ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  Cookie Banner verschijnt                               ‚îÇ
‚îÇ  ‚îú‚îÄ "Alleen noodzakelijk"  ‚Üí necessary: true            ‚îÇ
‚îÇ  ‚îú‚îÄ "Instellingen"         ‚Üí Kies per categorie         ‚îÇ
‚îÇ  ‚îî‚îÄ "Alles accepteren"     ‚Üí all: true                  ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                ‚îÇ
                ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  localStorage['kattenbak_cookie_consent']               ‚îÇ
‚îÇ  {                                                      ‚îÇ
‚îÇ    necessary: true,     // Altijd                       ‚îÇ
‚îÇ    functional: false,   // hCaptcha (opt-in)            ‚îÇ
‚îÇ    analytics: false,    // Google Analytics (opt-in)    ‚îÇ
‚îÇ    marketing: false,    // Facebook Pixel (opt-in)      ‚îÇ
‚îÇ    timestamp: 1234567890                                ‚îÇ
‚îÇ  }                                                      ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                ‚îÇ
                ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  User probeert chat/checkout                            ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                ‚îÇ
                ‚ñº
        ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
        ‚îÇ hasConsent()   ‚îÇ
        ‚îÇ check          ‚îÇ
        ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                ‚îÇ
        ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
        ‚îÇ                    ‚îÇ
        ‚ñº                    ‚ñº
    ‚ùå NEE              ‚úÖ JA
        ‚îÇ                    ‚îÇ
        ‚ñº                    ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ Toon warning ‚îÇ    ‚îÇ Laad hCaptcha  ‚îÇ
‚îÇ + Accept btn ‚îÇ    ‚îÇ Script         ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                             ‚îÇ
                             ‚ñº
                    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
                    ‚îÇ Verify token   ‚îÇ
                    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                             ‚îÇ
                             ‚ñº
                    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
                    ‚îÇ Submit form    ‚îÇ
                    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

---

## üîí SECURITY FEATURES

### 1. **Cookie Consent (GDPR)**
```typescript
// ‚úÖ DRY: Centralized in shared/cookies.config.ts
STORAGE_KEY: 'kattenbak_cookie_consent'
CONSENT_DURATION: 365 days
```

**Categories:**
- `necessary`: Altijd `true` (cart, session)
- `functional`: hCaptcha spam preventie (opt-in)
- `analytics`: Google Analytics (opt-in)
- `marketing`: Facebook Pixel (opt-in)

### 2. **hCaptcha Integration**
```typescript
// ‚úÖ Only loads if functional consent given
useHCaptcha() {
  if (!hasConsent('functional')) {
    return { canLoad: false }
  }
  // Load script & verify
}
```

**Flow:**
1. Check consent ‚Üí `hasConsent('functional')`
2. Load script ‚Üí `https://js.hcaptcha.com/1/api.js`
3. Get token ‚Üí `hcaptcha.execute()`
4. Verify backend ‚Üí `POST /verify with secret`

### 3. **Backend Verification**
```typescript
// backend/src/middleware/captcha.middleware.ts
export async function verifyCaptcha(token: string) {
  const response = await fetch(HCAPTCHA_VERIFY_URL, {
    method: 'POST',
    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
    body: `secret=${SECRET_KEY}&response=${token}`
  });
  
  return {
    valid: response.success,
    score: response.score
  };
}
```

**Backend checks:**
- ‚úÖ Token validity
- ‚úÖ Score threshold (>0.5)
- ‚úÖ IP rate limiting
- ‚úÖ Request signature

---

## üìã CHECKOUT FLOW (SECURE)

```typescript
// frontend/app/checkout/page.tsx

const handleSubmit = async (e) => {
  // 1. ‚úÖ Check functional cookies
  if (!hasConsent('functional')) {
    showCookieWarning();
    return;
  }
  
  // 2. ‚úÖ Validate form data
  if (!validateFormData(formData)) {
    showError();
    return;
  }
  
  // 3. ‚úÖ Create order (with schema validation)
  const orderData = {
    items: [{ productId, quantity, price }],
    customer: { firstName, lastName, email, phone },
    shipping: { address, city, postalCode, country },
    paymentMethod: 'ideal'
  };
  
  // 4. ‚úÖ Submit to backend
  const result = await ordersApi.create(orderData);
  
  // 5. ‚úÖ Redirect to Mollie payment
  window.location.href = result.paymentUrl;
};
```

**Backend validation:**
```typescript
// backend/src/routes/orders.routes.ts
const createOrderSchema = z.object({
  items: z.array(z.object({
    productId: z.string(),
    quantity: z.number().min(1),
    price: z.number().min(0)
  })).min(1),
  customer: z.object({
    firstName: z.string().min(2),
    lastName: z.string().min(2),
    email: z.string().email(),
    phone: z.string().min(10)
  }),
  shipping: z.object({
    address: z.string().min(5),
    city: z.string().min(2),
    postalCode: z.string().min(6),
    country: z.string().default('NL')
  }),
  paymentMethod: z.enum(['ideal', 'creditcard', 'bancontact', 'sofort'])
});
```

---

## üõ°Ô∏è SECURITY BEST PRACTICES

### ‚úÖ Implemented:
1. **GDPR Compliance**: Opt-in cookie consent
2. **Spam Prevention**: hCaptcha (functional cookies)
3. **Schema Validation**: Zod validation (frontend + backend)
4. **Rate Limiting**: Express rate limiter
5. **HTTPS Only**: Production cookies secure flag
6. **XSS Prevention**: React auto-escaping
7. **CSRF Protection**: SameSite cookies
8. **Input Sanitization**: Zod schema validation
9. **Environment Separation**: Dev/Prod configs
10. **Error Handling**: No sensitive data in errors

### üîí Production Checklist:
- [ ] Set `NODE_ENV=production`
- [ ] Use real Mollie API keys
- [ ] Enable HTTPS (SSL)
- [ ] Set secure cookie flags
- [ ] Update CORS origins
- [ ] Enable CSP headers
- [ ] Set up monitoring
- [ ] Database backups
- [ ] Rate limiting tuned
- [ ] hCaptcha production keys

---

## üìä ADMIN ENDPOINTS

### Contact Berichten:
```bash
# Alle berichten ophalen
GET /api/v1/contact

# Status updaten
PATCH /api/v1/contact/:id/status
Body: { "status": "read" | "replied" }
```

### Bestellingen:
```bash
# Alle orders
GET /api/v1/orders

# Order details
GET /api/v1/orders/:id
```

---

## ‚úÖ DRY & MAINTAINABLE

**Centralized Config:**
- `shared/cookies.config.ts` ‚Üí Cookie categories
- `shared/hcaptcha.config.ts` ‚Üí hCaptcha settings
- `lib/config.ts` ‚Üí API endpoints
- `lib/theme-colors.ts` ‚Üí UI colors

**Reusable Hooks:**
- `use-cookie-consent.ts` ‚Üí Cookie management
- `use-hcaptcha.ts` ‚Üí Spam prevention

**Type Safety:**
- Zod schemas voor validation
- TypeScript types voor alle data
- Strict mode enabled

---

**Status:** ‚úÖ PRODUCTION READY (na checklist)
**Last Updated:** 2025-12-12


