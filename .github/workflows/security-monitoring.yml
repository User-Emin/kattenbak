# âœ… SECURITY MONITORING - Automated Security Checks & Notifications
# E2E Secure: Monitors security vulnerabilities and sends email alerts
# Runs daily at 06:00 UTC (07:00 CET)

name: Security Monitoring & Alerting

on:
  schedule:
    # Run daily at 06:00 UTC (07:00 CET, 08:00 CEST)
    - cron: '0 6 * * *'
  workflow_dispatch: # Allow manual trigger

jobs:
  security-audit:
    name: Security Audit & Dependency Check
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      # Backend Security Audit
      - name: Backend Security Audit
        working-directory: ./backend
        run: |
          npm audit --audit-level=moderate --json > backend-audit.json || true
          if [ -s backend-audit.json ]; then
            VULNERABILITIES=$(jq -r '.metadata.vulnerabilities.total // 0' backend-audit.json)
            if [ "$VULNERABILITIES" -gt 0 ]; then
              echo "âš ï¸ Backend: $VULNERABILITIES vulnerabilities found"
              echo "BACKEND_VULNERABILITIES=$VULNERABILITIES" >> $GITHUB_ENV
              jq -r '.vulnerabilities[] | "\(.name): \(.severity) - \(.title)"' backend-audit.json > backend-vulns.txt
            else
              echo "âœ… Backend: No vulnerabilities"
            fi
          fi

      # Frontend Security Audit
      - name: Frontend Security Audit
        working-directory: ./frontend
        run: |
          npm audit --audit-level=moderate --json > ../frontend-audit.json || true
          if [ -s ../frontend-audit.json ]; then
            VULNERABILITIES=$(jq -r '.metadata.vulnerabilities.total // 0' ../frontend-audit.json)
            if [ "$VULNERABILITIES" -gt 0 ]; then
              echo "âš ï¸ Frontend: $VULNERABILITIES vulnerabilities found"
              echo "FRONTEND_VULNERABILITIES=$VULNERABILITIES" >> $GITHUB_ENV
              jq -r '.vulnerabilities[] | "\(.name): \(.severity) - \(.title)"' ../frontend-audit.json > ../frontend-vulns.txt
            else
              echo "âœ… Frontend: No vulnerabilities"
            fi
          fi

      # Admin Security Audit
      - name: Admin Security Audit
        working-directory: ./admin-next
        run: |
          npm audit --audit-level=moderate --json > ../admin-audit.json || true
          if [ -s ../admin-audit.json ]; then
            VULNERABILITIES=$(jq -r '.metadata.vulnerabilities.total // 0' ../admin-audit.json)
            if [ "$VULNERABILITIES" -gt 0 ]; then
              echo "âš ï¸ Admin: $VULNERABILITIES vulnerabilities found"
              echo "ADMIN_VULNERABILITIES=$VULNERABILITIES" >> $GITHUB_ENV
              jq -r '.vulnerabilities[] | "\(.name): \(.severity) - \(.title)"' ../admin-audit.json > ../admin-vulns.txt
            else
              echo "âœ… Admin: No vulnerabilities"
            fi
          fi

      # âœ… DISABLED: Email alerts removed - check GitHub Actions UI instead
      - name: Security Alert Summary
        if: env.BACKEND_VULNERABILITIES > 0 || env.FRONTEND_VULNERABILITIES > 0 || env.ADMIN_VULNERABILITIES > 0
        run: |
          echo "âš ï¸ Security vulnerabilities detected:"
          echo "   Backend: ${{ env.BACKEND_VULNERABILITIES || 0 }}"
          echo "   Frontend: ${{ env.FRONTEND_VULNERABILITIES || 0 }}"
          echo "   Admin: ${{ env.ADMIN_VULNERABILITIES || 0 }}"
          echo "   View full report: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"

      # Dependency Update Check
      - name: Check for Outdated Dependencies
        run: |
          echo "Checking for outdated dependencies..."
          
          cd backend && npm outdated --json > ../backend-outdated.json || true
          cd ../frontend && npm outdated --json > ../frontend-outdated.json || true
          cd ../admin-next && npm outdated --json > ../admin-outdated.json || true
          
          BACKEND_OUTDATED=$(jq -r 'length' backend-outdated.json 2>/dev/null || echo "0")
          FRONTEND_OUTDATED=$(jq -r 'length' frontend-outdated.json 2>/dev/null || echo "0")
          ADMIN_OUTDATED=$(jq -r 'length' admin-outdated.json 2>/dev/null || echo "0")
          
          TOTAL_OUTDATED=$((BACKEND_OUTDATED + FRONTEND_OUTDATED + ADMIN_OUTDATED))
          
          echo "BACKEND_OUTDATED=$BACKEND_OUTDATED" >> $GITHUB_ENV
          echo "FRONTEND_OUTDATED=$FRONTEND_OUTDATED" >> $GITHUB_ENV
          echo "ADMIN_OUTDATED=$ADMIN_OUTDATED" >> $GITHUB_ENV
          echo "TOTAL_OUTDATED=$TOTAL_OUTDATED" >> $GITHUB_ENV

      # âœ… DISABLED: Email alerts removed - check GitHub Actions UI instead
      - name: Dependency Update Summary
        if: env.TOTAL_OUTDATED > 10
        run: |
          echo "ðŸ“¦ Outdated dependencies detected:"
          echo "   Backend: ${{ env.BACKEND_OUTDATED }}"
          echo "   Frontend: ${{ env.FRONTEND_OUTDATED }}"
          echo "   Admin: ${{ env.ADMIN_OUTDATED }}"
          echo "   Total: ${{ env.TOTAL_OUTDATED }}"
          echo "   Repository: https://github.com/${{ github.repository }}"
