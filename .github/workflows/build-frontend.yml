name: üî® Build Frontend (GitHub Actions)

on:
  push:
    branches: [main]
    paths:
      - 'frontend/**'
      - '.github/workflows/build-frontend.yml'
  workflow_dispatch:

env:
  NODE_VERSION: '22.x'

# üîí SECURITY: Minimal permissions - only what's needed
permissions:
  contents: read
  actions: read

jobs:
  build-frontend:
    name: Build Frontend
    runs-on: ubuntu-latest
    
    steps:
      - name: üì• Checkout
        uses: actions/checkout@v4
      
      - name: üì¶ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          # Cache disabled to avoid warnings - not critical for build success
      
      - name: üì• Install Dependencies
        working-directory: ./frontend
        run: npm ci
      
      - name: üî® Build Frontend
        working-directory: ./frontend
        env:
          NODE_OPTIONS: '--max-old-space-size=4096'
          NEXT_TELEMETRY_DISABLED: 1
        run: npm run build
      
      - name: üì¶ Upload Build Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: frontend-build
          path: |
            frontend/.next
            frontend/public
          retention-days: 1
      
      - name: üì§ Deploy to Server
        continue-on-error: true
        run: |
          # ‚úÖ FIX: Use standard SSH instead of deprecated action
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ secrets.SERVER_HOST }} >> ~/.ssh/known_hosts 2>/dev/null || true
          
          # Deploy using rsync
          rsync -avz --delete \
            -e "ssh -i ~/.ssh/id_rsa" \
            frontend/.next/ \
            ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }}:/var/www/kattenbak/frontend/.next/ || echo "‚ö†Ô∏è Deploy skipped"
      
      - name: üîÑ Restart Frontend
        continue-on-error: true
        run: |
          ssh -i ~/.ssh/id_rsa -o StrictHostKeyChecking=no ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} << 'EOF' || echo "‚ö†Ô∏è Restart skipped"
            cd /var/www/kattenbak
            pm2 restart frontend || pm2 start ecosystem.config.js --only frontend
            sleep 5
            pm2 list
          EOF
