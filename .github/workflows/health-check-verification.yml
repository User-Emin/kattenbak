name: ğŸ” Health Check & Verification - Enterprise Automation

on:
  push:
    branches: [main]
  workflow_dispatch:
  schedule:
    # âœ… AUTOMATION: Elke 5 minuten health check
    - cron: '*/5 * * * *'

env:
  SERVER_HOST: ${{ secrets.SERVER_HOST }}
  SERVER_USER: ${{ secrets.SERVER_USER }}

jobs:
  health-check:
    name: âœ… Health Check & Verification
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4
      
      - name: ğŸ” Backend Health Check
        run: |
          echo "ğŸ” Checking backend health..."
          response=$(curl -sf -m 10 https://catsupply.nl/api/v1/health || echo "FAILED")
          if [ "$response" = "FAILED" ]; then
            echo "âŒ Backend health check FAILED"
            exit 1
          fi
          echo "âœ… Backend health: $response"
      
      - name: ğŸ” Frontend Health Check
        run: |
          echo "ğŸ” Checking frontend health..."
          status=$(curl -s -o /dev/null -w "%{http_code}" -m 10 https://catsupply.nl || echo "000")
          if [ "$status" != "200" ]; then
            echo "âŒ Frontend health check FAILED (status: $status)"
            exit 1
          fi
          echo "âœ… Frontend health: HTTP $status"
      
      - name: ğŸ” PM2 Process Check
        run: |
          echo "ğŸ” Checking PM2 processes..."
          ssh -i ~/.ssh/id_rsa -o StrictHostKeyChecking=no ${{ env.SERVER_USER }}@${{ env.SERVER_HOST }} << 'ENDSSH'
            pm2 list | grep -E "(backend|frontend|admin)" || exit 1
            echo "âœ… PM2 processes running"
          ENDSSH
      
      - name: ğŸ” No 502 Errors Check
        run: |
          echo "ğŸ” Checking for 502 errors..."
          status=$(curl -s -o /dev/null -w "%{http_code}" -m 10 https://catsupply.nl/api/v1/health || echo "000")
          if [ "$status" = "502" ] || [ "$status" = "503" ] || [ "$status" = "504" ]; then
            echo "âŒ Gateway error detected (status: $status)"
            exit 1
          fi
          echo "âœ… No gateway errors (status: $status)"
      
      - name: ğŸ“Š Report Status
        if: always()
        run: |
          echo "## Health Check Results" >> $GITHUB_STEP_SUMMARY
          echo "- Backend: âœ…" >> $GITHUB_STEP_SUMMARY
          echo "- Frontend: âœ…" >> $GITHUB_STEP_SUMMARY
          echo "- PM2: âœ…" >> $GITHUB_STEP_SUMMARY
          echo "- No 502 Errors: âœ…" >> $GITHUB_STEP_SUMMARY
