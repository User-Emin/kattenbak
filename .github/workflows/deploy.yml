name: üöÄ Production Deploy & Test

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

# Prevent concurrent deploys
concurrency:
  group: production-deploy
  cancel-in-progress: false

env:
  SERVER_IP: 185.224.139.74
  DEPLOY_USER: root
  NODE_VERSION: '20'

jobs:
  # ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
  # JOB 1: BUILD & TEST LOCAL
  # ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
  test-build:
    name: üß™ Build & Test
    runs-on: ubuntu-latest
    
    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v4
      
      - name: üì¶ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: |
            backend/package-lock.json
            frontend/package-lock.json
      
      - name: üî® Build Backend
        run: |
          cd backend
          npm ci
          npm run build
        
      - name: üî® Build Frontend
        run: |
          cd frontend
          npm ci
          NEXT_PUBLIC_API_URL="https://api.catsupply.nl" npm run build
      
      - name: ‚úÖ Build Success
        run: echo "‚úÖ All builds successful"

  # ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
  # JOB 2: DEPLOY TO PRODUCTION
  # ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
  deploy:
    name: üöÄ Deploy to Production
    runs-on: ubuntu-latest
    needs: test-build
    if: github.ref == 'refs/heads/main'
    
    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v4
      
      - name: üîë Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519
          ssh-keyscan -H ${{ env.SERVER_IP }} >> ~/.ssh/known_hosts
      
      - name: üì§ Deploy Code
        run: |
          ssh ${{ env.DEPLOY_USER }}@${{ env.SERVER_IP }} << 'DEPLOY'
            set -e
            cd /var/www/kattenbak
            
            echo "üì• Pulling latest code..."
            git pull origin main
            
            echo "üî® Building backend..."
            cd backend
            npm ci --production
            npx swc src -d dist --copy-files
            npx prisma generate
            
            echo "üî® Building frontend..."
            cd ../frontend
            npm ci --production
            NEXT_PUBLIC_API_URL="https://api.catsupply.nl" npm run build
            
            echo "‚úÖ Build complete"
          DEPLOY
      
      - name: üîÑ Restart Services
        run: |
          ssh ${{ env.DEPLOY_USER }}@${{ env.SERVER_IP }} << 'RESTART'
            pm2 restart backend
            pm2 restart frontend
            sleep 10
            pm2 status
          RESTART
      
      - name: ‚úÖ Deployment Complete
        run: echo "‚úÖ Deployed to ${{ env.SERVER_IP }}"

  # ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
  # JOB 3: POST-DEPLOY VERIFICATION (BLOCKS ON FAILURE!)
  # ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
  verify:
    name: ‚úÖ Verify Deployment
    runs-on: ubuntu-latest
    needs: deploy
    
    steps:
      - name: üîë Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519
          ssh-keyscan -H ${{ env.SERVER_IP }} >> ~/.ssh/known_hosts
      
      - name: üè• Health Check - Backend
        run: |
          echo "Testing backend health..."
          RESPONSE=$(curl -s -o /dev/null -w "%{http_code}" http://${{ env.SERVER_IP }}:3101/health)
          
          if [ "$RESPONSE" != "200" ]; then
            echo "‚ùå Backend health check FAILED (HTTP $RESPONSE)"
            ssh ${{ env.DEPLOY_USER }}@${{ env.SERVER_IP }} "pm2 logs backend --lines 50 --nostream"
            exit 1
          fi
          
          echo "‚úÖ Backend health: OK"
      
      - name: üè• Health Check - Frontend
        run: |
          echo "Testing frontend..."
          RESPONSE=$(curl -s -o /dev/null -w "%{http_code}" http://${{ env.SERVER_IP }}:3102)
          
          if [ "$RESPONSE" != "200" ]; then
            echo "‚ùå Frontend health check FAILED (HTTP $RESPONSE)"
            ssh ${{ env.DEPLOY_USER }}@${{ env.SERVER_IP }} "pm2 logs frontend --lines 50 --nostream"
            exit 1
          fi
          
          echo "‚úÖ Frontend health: OK"
      
      - name: üîç PM2 Status Check
        run: |
          ssh ${{ env.DEPLOY_USER }}@${{ env.SERVER_IP }} << 'PM2CHECK'
            # Check if all processes are online
            OFFLINE=$(pm2 jlist | jq -r '.[] | select(.pm2_env.status != "online") | .name')
            
            if [ -n "$OFFLINE" ]; then
              echo "‚ùå Some processes are not online: $OFFLINE"
              pm2 status
              exit 1
            fi
            
            echo "‚úÖ All PM2 processes online"
            pm2 status
          PM2CHECK
      
      - name: üß™ API Endpoint Tests
        run: |
          echo "Testing critical API endpoints..."
          
          # Test /api/products
          PRODUCTS=$(curl -s -o /dev/null -w "%{http_code}" http://${{ env.SERVER_IP }}:3101/api/products)
          if [ "$PRODUCTS" != "200" ]; then
            echo "‚ùå /api/products failed (HTTP $PRODUCTS)"
            exit 1
          fi
          echo "‚úÖ /api/products: OK"
          
          # Test /api/payment-methods
          PAYMENT=$(curl -s -o /dev/null -w "%{http_code}" http://${{ env.SERVER_IP }}:3101/api/payment-methods)
          if [ "$PAYMENT" != "200" ]; then
            echo "‚ùå /api/payment-methods failed (HTTP $PAYMENT)"
            exit 1
          fi
          echo "‚úÖ /api/payment-methods: OK"
      
      - name: üìä Database Connection Test
        run: |
          ssh ${{ env.DEPLOY_USER }}@${{ env.SERVER_IP }} << 'DBTEST'
            if ! PGPASSWORD='lsavaoC57Cs05N8stXAujrGtDGEvZfxC' psql -h localhost -U kattenbak_user -d kattenbak_prod -c 'SELECT 1' > /dev/null 2>&1; then
              echo "‚ùå Database connection FAILED"
              exit 1
            fi
            echo "‚úÖ Database connection: OK"
          DBTEST
      
      - name: üéâ All Checks Passed
        run: |
          echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
          echo "‚úÖ DEPLOYMENT VERIFIED & HEALTHY"
          echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
          echo "Backend:  http://${{ env.SERVER_IP }}:3101/health"
          echo "Frontend: http://${{ env.SERVER_IP }}"
          echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"

  # ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
  # JOB 4: ROLLBACK ON FAILURE
  # ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
  rollback:
    name: üîÑ Rollback on Failure
    runs-on: ubuntu-latest
    needs: verify
    if: failure()
    
    steps:
      - name: üîë Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519
          ssh-keyscan -H ${{ env.SERVER_IP }} >> ~/.ssh/known_hosts
      
      - name: ‚èÆÔ∏è Rollback to Previous Version
        run: |
          ssh ${{ env.DEPLOY_USER }}@${{ env.SERVER_IP }} << 'ROLLBACK'
            echo "üîÑ Rolling back to previous version..."
            cd /var/www/kattenbak
            git reset --hard HEAD~1
            
            # Rebuild
            cd backend && npx swc src -d dist --copy-files && cd ..
            cd frontend && npm run build && cd ..
            
            # Restart
            pm2 restart all
            
            echo "‚úÖ Rollback complete"
          ROLLBACK
      
      - name: üìß Notify Failure
        run: |
          echo "‚ùå DEPLOYMENT FAILED - ROLLED BACK"
          echo "Check logs and fix issues before redeploying"
