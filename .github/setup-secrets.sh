#!/bin/bash

# ðŸ” GitHub Secrets Setup Script
# ============================================================================
# Dit script helpt je om alle benodigde GitHub Secrets te configureren
# ============================================================================

set -e

echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "ðŸ” GitHub Secrets Setup - CI/CD Pipeline"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo ""

# Check if GitHub CLI is installed
if ! command -v gh &> /dev/null; then
    echo "âŒ GitHub CLI (gh) is not installed"
    echo "Install it from: https://cli.github.com/"
    echo ""
    echo "Or use Homebrew: brew install gh"
    exit 1
fi

echo "âœ… GitHub CLI found"
echo ""

# Check if authenticated
if ! gh auth status &> /dev/null; then
    echo "ðŸ”‘ Please authenticate with GitHub CLI:"
    gh auth login
fi

echo "âœ… Authenticated with GitHub"
echo ""

# Get repository info
REPO=$(gh repo view --json nameWithOwner -q .nameWithOwner)
echo "ðŸ“¦ Repository: $REPO"
echo ""

# ============================================================================
# 1. SSH_PRIVATE_KEY
# ============================================================================
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "1ï¸âƒ£  SSH_PRIVATE_KEY"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo ""

SSH_KEY_PATH="$HOME/.ssh/github-deploy"

if [ -f "$SSH_KEY_PATH" ]; then
    echo "âœ… SSH key found at $SSH_KEY_PATH"
    read -p "Use this key? (y/n): " USE_EXISTING
    
    if [ "$USE_EXISTING" != "y" ]; then
        echo "Generating new SSH key..."
        ssh-keygen -t rsa -b 4096 -C "github-actions@catsupply.nl" -f "$SSH_KEY_PATH" -N ""
    fi
else
    echo "ðŸ”‘ Generating new SSH key..."
    ssh-keygen -t rsa -b 4096 -C "github-actions@catsupply.nl" -f "$SSH_KEY_PATH" -N ""
fi

echo ""
echo "ðŸ“‹ Copy this PUBLIC key to your server:"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
cat "${SSH_KEY_PATH}.pub"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo ""
echo "Run this on your server (185.224.139.74):"
echo "mkdir -p ~/.ssh && echo '$(cat ${SSH_KEY_PATH}.pub)' >> ~/.ssh/authorized_keys"
echo ""
read -p "Press Enter when done..."

# Upload private key to GitHub
gh secret set SSH_PRIVATE_KEY < "$SSH_KEY_PATH"
echo "âœ… SSH_PRIVATE_KEY uploaded to GitHub"
echo ""

# ============================================================================
# 2. SERVER_HOST
# ============================================================================
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "2ï¸âƒ£  SERVER_HOST"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo ""

read -p "Enter server IP (default: 185.224.139.74): " SERVER_HOST
SERVER_HOST=${SERVER_HOST:-185.224.139.74}

echo "$SERVER_HOST" | gh secret set SERVER_HOST
echo "âœ… SERVER_HOST set to: $SERVER_HOST"
echo ""

# ============================================================================
# 3. SERVER_USER
# ============================================================================
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "3ï¸âƒ£  SERVER_USER"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo ""

read -p "Enter server user (default: root): " SERVER_USER
SERVER_USER=${SERVER_USER:-root}

echo "$SERVER_USER" | gh secret set SERVER_USER
echo "âœ… SERVER_USER set to: $SERVER_USER"
echo ""

# ============================================================================
# 4. DB_USER
# ============================================================================
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "4ï¸âƒ£  DB_USER"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo ""

read -p "Enter database user (default: kattenbak_user): " DB_USER
DB_USER=${DB_USER:-kattenbak_user}

echo "$DB_USER" | gh secret set DB_USER
echo "âœ… DB_USER set to: $DB_USER"
echo ""

# ============================================================================
# 5. DB_PASSWORD
# ============================================================================
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "5ï¸âƒ£  DB_PASSWORD"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo ""

read -sp "Enter database password: " DB_PASSWORD
echo ""

if [ -z "$DB_PASSWORD" ]; then
    echo "âŒ Password cannot be empty"
    exit 1
fi

echo "$DB_PASSWORD" | gh secret set DB_PASSWORD
echo "âœ… DB_PASSWORD set"
echo ""

# ============================================================================
# 6. DB_NAME
# ============================================================================
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "6ï¸âƒ£  DB_NAME"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo ""

read -p "Enter database name (default: kattenbak_prod): " DB_NAME
DB_NAME=${DB_NAME:-kattenbak_prod}

echo "$DB_NAME" | gh secret set DB_NAME
echo "âœ… DB_NAME set to: $DB_NAME"
echo ""

# ============================================================================
# SUMMARY
# ============================================================================
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "âœ… ALL SECRETS CONFIGURED!"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo ""
echo "Configured secrets:"
echo "  âœ… SSH_PRIVATE_KEY"
echo "  âœ… SERVER_HOST:    $SERVER_HOST"
echo "  âœ… SERVER_USER:    $SERVER_USER"
echo "  âœ… DB_USER:        $DB_USER"
echo "  âœ… DB_PASSWORD:    ********"
echo "  âœ… DB_NAME:        $DB_NAME"
echo ""
echo "ðŸš€ Your CI/CD pipeline is ready!"
echo ""
echo "Next steps:"
echo "  1. Verify secrets: gh secret list"
echo "  2. Push to main: git push origin main"
echo "  3. Watch deployment: gh run watch"
echo ""
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

